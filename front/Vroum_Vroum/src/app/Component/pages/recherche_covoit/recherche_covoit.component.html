<div class="page-wrapper">
  <div class="animated-bg"></div>
  <div class=" container">

    <!-- Recherche -->
    <div class="card bg-card m-1">
      <div class="card-body">
        <h4 class="card-title mb-1">Rechercher un covoiturage ðŸš—</h4>
        <p class="text-decoration-underline text-info ">Choisissez votre destination et partez ensemble! </p>

        <form (ngSubmit)="rechercher()" class="form" #formRef="ngForm">
          <div class="row gx-3 gy-2">
            <div class="col-md-6">
              <input class="form-control" [(ngModel)]="filtres.villedep" name="villedep" placeholder="Ville de dÃ©part">
            </div>
            <div class="col-md-6">
              <input class="form-control" [(ngModel)]="filtres.cpdep" name="cpdep" placeholder="Code postal">
            </div>

            <div class="col-md-6">
              <input class="form-control" [(ngModel)]="filtres.villearr" name="villearr" placeholder="Ville dâ€™arrivÃ©e">
            </div>
            <div class="col-md-6">
              <input class="form-control" [(ngModel)]="filtres.cparr" name="cparr" placeholder="Code postal arrivÃ©e">
            </div>

            <div class="col-md-12">
              <input type="datetime-local" class="form-control" [(ngModel)]="filtres.date" name="date">
            </div>

            <div class="col-md-12 d-flex align-items-end">
              <button type="submit" class="btn btn-primary w-100">Rechercher</button>
            </div>
          </div>
        </form>

        <div *ngIf="erreurMessage" class="mt-3">
          <div class="alert alert-danger mb-0" role="alert">{{ erreurMessage }}</div>
        </div>
      </div>
    </div>

    <!-- RÃ©sultats -->
    <div *ngIf="covoiturages && covoiturages.length > 0" class="cards-grid">
      <div class="row g-3">
        <div class="col-12 col-sm-6 col-md-4 col-lg-3" *ngFor="let c of covoiturages">
          <div class="card h-100 bg-card">
            <div class="card-body">
              <h5 class="card-title mb-2">
                <span class="text-decoration-underline text-info">{{ c.adresseDepart?.nomVille || 'â€”' }}</span>
                <small class="text-info mx-2">â†’</small>
                <span class="text-decoration-underline text-info">{{ c.adresseArrivee?.nomVille || 'â€”' }}</span>
              </h5>
              <p class="mb-1"><strong>Date :</strong> {{ c.date ? (c.date | date:'short') : 'Non prÃ©cisÃ©e' }}</p>
              <p class="mb-1"><strong>Conducteur :</strong> {{ c.organisateur?.prenom || 'â€”' }} {{ c.organisateur?.nom || '' }}</p>
              <p class="mb-0"><strong>VÃ©hicule :</strong> {{ c.vehicule?.marque || 'â€”' }} {{ c.vehicule?.modele || '' }}</p>
            </div>
            <div class="card-footer bg-transparent d-flex gap-2">
              <!-- bouton qui ouvre la popup -->
              <button class="btn btn-success btn-sm" (click)="ouvrirPopup(c)">RÃ©server</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="(!covoiturages || covoiturages.length === 0) && !erreurMessage" class="text-center text-muted mt-3">
    Aucun rÃ©sultat
  </div>
  <!-- modal crÃ©e/dÃ©truit selon popupVisible -->
  <div *ngIf="popupVisible" class="modal show d-block simple-modal" tabindex="-1" aria-modal="true" role="dialog" (click)="fermerPopup()">
    <div class="modal-dialog modal-dialog-centered simple-modal-dialog" (click)="$event.stopPropagation()">
      <div class="modal-content simple-modal-content bg-card" style ="background-color: rgba(2,10,25,0.7);">
        <div class="modal-header">
          <h5 class="modal-title">DÃ©tails du covoiturage</h5>
        </div>

        <div class="modal-body p-3">
          <!-- Affichage sÃ©curisÃ© des infos : utilise les safe-nav opÃ©rateurs -->
          <p *ngIf="covoiturageSelectionne">
            <strong>Trajet :</strong>
            {{ covoiturageSelectionne.adresseDepart?.nomVille || 'â€”' }} â†’
            {{ covoiturageSelectionne.adresseArrivee?.nomVille || 'â€”' }}
          </p>

          <p *ngIf="covoiturageSelectionne"><strong>Date :</strong>
            {{ covoiturageSelectionne.date ? (covoiturageSelectionne.date | date:'short') : 'Non prÃ©cisÃ©e' }}
          </p>

          <p *ngIf="covoiturageSelectionne"><strong>Conducteur :</strong>
            {{ covoiturageSelectionne.organisateur?.prenom || 'â€”' }} {{ covoiturageSelectionne.organisateur?.nom || '' }}
          </p>

          <p *ngIf="covoiturageSelectionne"><strong>VÃ©hicule :</strong>
            {{ covoiturageSelectionne.vehicule?.marque || 'â€”' }} {{ covoiturageSelectionne.vehicule?.modele || '' }}
          </p>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="fermerPopup()">Annuler</button>
          <button type="button" class="btn btn-success" (click)="validerReservation()">Confirmer</button>
        </div>
      </div>
    </div>
  </div>
</div>

